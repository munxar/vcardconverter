<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Konverter</title>
</head>
<body>
<input id="file" type="file">
<div id="out"></div>

<table id="table">
    <thead id="thead"></thead>
    <tbody id="tbody"></tbody>
</table>

<script>
    var file = document.getElementById("file");
    var out = document.getElementById("out");
    var tbody = document.getElementById("tbody");
    var thead = document.getElementById("thead");

    file.addEventListener("change", function (e) {
        var file = e.target.files[0];
        var reader = new FileReader();
        reader.onload = function (e) {
            var content = e.target.result;
            var lines = content.split("\n");
            var cards = extrakt(lines);
            render(cards);
        };
        reader.readAsText(file);
    }, false);

    function attr(regex, name, parse) {
        return {regex: regex, name: name, parse: parse};
    }

    function split(line) {
        return line.split(":")[1];
    }
    function removeEmpty(value) {
        return value;
    }

    var attrs = [
        attr(/^FN:/, "fullname", function(line, card) {
            card.fullname = split(line);
        }),
        attr(/^N:/, "lastname", function(line, card) {
            card.lastname = split(line).split(";")[0];
        }),
        attr(/^N:/, "firstname", function(line, card) {
            card.firstname = split(line).split(";")[1];
        }),
        attr(/^TITLE:/, "title", function(line, card) {
            card.title = split(line);
        }),
        attr(/^EMAIL/, "email", function(line, card) {
            card.email = card.email || [];
            card.email.push(split(line));
        }),
        attr(/^TEL/, "tel", function(line, card) {
            card.tel = card.tel || [];
            card.tel.push(split(line));
        }),
        attr(/^ADR/, "address", function(line, card) {
            card.address = card.address || [];
            card.address.push(split(line).split(";").filter(removeEmpty).join(","));
        }),
        attr(/^BDAY/, "birthday", function(line, card) {
            card.birthday = split(line);
        }),
        attr(/^CATEGORIES:/, "categories", function(line, card) {
            card.categories = split(line);
        }),
        attr(/^NOTE:/, "note", function(line, card) {
            card.note = split(line);
        }),
        attr(/^ORG:/, "org", function(line, card) {
            card.org = split(line);
        })
    ];

    function extrakt(lines) {
        var cards = [];
        var card = {};

        lines.forEach(function (line) {
            if(/BEGIN:VCARD/.test(line)) {
                card = {};
            }
            if(/END:VCARD/.test(line)) {
                cards.push(card);
            }
            attrs.forEach(function (attr) {
                if(attr.regex.test(line)) {
                    attr.parse(line, card);
                }
            });
        });
        return cards;
    }

    function print(value) {
        return value ? value : "";
    }

    function render(cards) {
        thead.innerHTML = "<tr>" + attrs.map(function(attr) {
                    return "<th>" + attr.name + "</th>"
                }).join("") + "</tr>";

        tbody.innerHTML = cards.map(function (card) {
            return "<tr>"
                    + attrs.map(function(attr) {
                        return "<td>" +print(card[attr.name]) + "</td>";
                    }).join("")
                    + "</tr>";
        }).join("");
    }

</script>
</body>
</html>